---
###############################################################################
#
# Ansible Playbook generated from evaluation of DISA STIG for Red Hat Enterprise Linux 8 [CUSTOMIZED]
#
# Profile ID: xccdf_org.ssgproject.content_profile_stig_custom1
# XCCDF Version:  unknown
#
# Evaluation Start Time:  2025-08-01T02:31:34-05:00
# Evaluation End Time:  2025-08-01T02:31:34-05:00
#
# This file was generated by OpenSCAP 1.3.6 using:
# $ oscap xccdf generate fix --result-id xccdf_org.open-scap_testresult_xccdf_org.ssgproject.content_profile_stig_custom1 --fix-type ansible xccdf-results.xml
#
# This Ansible Playbook is generated from the results of a profile evaluation.
# It attempts to remediate all issues from the selected rules that failed the test.
#
# How to apply this Ansible Playbook:
# $ ansible-playbook -i "localhost," -c local playbook.yml
# $ ansible-playbook -i "192.168.1.155," playbook.yml
# $ ansible-playbook -i inventory.ini playbook.yml
#
###############################################################################


- hosts: all
  vars:
    var_password_pam_dcredit: !!str -1
    var_password_pam_dictcheck: !!str 1
    var_password_pam_difok: !!str 8
    var_password_pam_lcredit: !!str -1
    var_password_pam_maxclassrepeat: !!str 4
    var_password_pam_maxrepeat: !!str 2
    var_password_pam_minclass: !!str 4
    var_password_pam_minlen: !!str 20
    var_password_pam_ocredit: !!str -1
    var_password_pam_ucredit: !!str -1
    var_rekey_limit_size: !!str 1G
    var_rekey_limit_time: !!str 1h
  tasks:
    - name: Ensure aide is installed
      package:
        name: aide
        state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80844-4
        - CJIS-5.10.1.3
        - DISA-STIG-RHEL-08-010359
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-11.5
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_aide_installed


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80653-9
        - DISA-STIG-RHEL-08-020130
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_dcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable dcredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*dcredit
        line: dcredit = {{ var_password_pam_dcredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80653-9
        - DISA-STIG-RHEL-08-020130
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_dcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-86233-4
        - DISA-STIG-RHEL-08-020300
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_dictcheck
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable dictcheck is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*dictcheck
        line: dictcheck = {{ var_password_pam_dictcheck }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-86233-4
        - DISA-STIG-RHEL-08-020300
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_dictcheck
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80654-7
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-08-020170
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(b)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_difok
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable difok is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*difok
        line: difok = {{ var_password_pam_difok }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80654-7
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-08-020170
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(b)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_difok
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-83364-0
        - NIST-800-53-AC-2(1)
        - accounts_password_pam_enforce_local
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure PAM Enforces Password Requirements - Enforce for Local Accounts Only
      lineinfile:
        path: /etc/security/pwquality.conf
        create: true
        line: local_users_only
        state: present
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-83364-0
        - NIST-800-53-AC-2(1)
        - accounts_password_pam_enforce_local
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-83377-2
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_enforce_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure PAM Enforces Password Requirements - Enforce for root User
      lineinfile:
        path: /etc/security/pwquality.conf
        create: true
        line: enforce_for_root
        state: present
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-83377-2
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_enforce_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80655-4
        - DISA-STIG-RHEL-08-020120
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_lcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable lcredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*lcredit
        line: lcredit = {{ var_password_pam_lcredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80655-4
        - DISA-STIG-RHEL-08-020120
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_lcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-81034-1
        - DISA-STIG-RHEL-08-020140
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_maxclassrepeat
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable maxclassrepeat is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*maxclassrepeat
        line: maxclassrepeat = {{ var_password_pam_maxclassrepeat }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-81034-1
        - DISA-STIG-RHEL-08-020140
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_maxclassrepeat
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82066-2
        - DISA-STIG-RHEL-08-020150
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_maxrepeat
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable maxrepeat is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*maxrepeat
        line: maxrepeat = {{ var_password_pam_maxrepeat }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82066-2
        - DISA-STIG-RHEL-08-020150
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_maxrepeat
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-82046-4
        - DISA-STIG-RHEL-08-020160
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_minclass
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable minclass is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*minclass
        line: minclass = {{ var_password_pam_minclass }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-82046-4
        - DISA-STIG-RHEL-08-020160
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_minclass
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80656-2
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-08-020230
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_minlen
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable minlen is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*minlen
        line: minlen = {{ var_password_pam_minlen }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80656-2
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-08-020230
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_minlen
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80663-8
        - DISA-STIG-RHEL-08-020280
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_ocredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable ocredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*ocredit
        line: ocredit = {{ var_password_pam_ocredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80663-8
        - DISA-STIG-RHEL-08-020280
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_ocredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80665-3
        - DISA-STIG-RHEL-08-020110
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_ucredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy



    - name: Ensure PAM variable ucredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*ucredit
        line: ucredit = {{ var_password_pam_ucredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80665-3
        - DISA-STIG-RHEL-08-020110
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_ucredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Ensure fapolicyd is installed
      package:
        name: fapolicyd
        state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82191-8
        - DISA-STIG-RHEL-08-040135
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-4(22)
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_fapolicyd_installed


    - name: Enable service fapolicyd
      block:

        - name: Gather the package facts
          package_facts:
            manager: auto

        - name: Enable service fapolicyd
          service:
            name: fapolicyd
            enabled: 'yes'
            state: started
            masked: 'no'
          when:
            - '"fapolicyd" in ansible_facts.packages'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82249-4
        - DISA-STIG-RHEL-08-040136
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-4(22)
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_fapolicyd_enabled


    - name: Enable service rngd
      block:

        - name: Gather the package facts
          package_facts:
            manager: auto

        - name: Enable service rngd
          service:
            name: rngd
            enabled: 'yes'
            state: started
            masked: 'no'
          when:
            - '"rng-tools" in ansible_facts.packages'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82831-9
        - DISA-STIG-RHEL-08-010471
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_rngd_enabled


    - name: Disable GSSAPI Authentication
      block:

        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*GSSAPIAuthentication\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes

        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*GSSAPIAuthentication\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1

        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*GSSAPIAuthentication\s+
            line: GSSAPIAuthentication no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80897-2
        - DISA-STIG-RHEL-08-010522
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_gssapi_auth


    - name: Disable SSH Root Login
      block:

        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PermitRootLogin\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes

        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*PermitRootLogin\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1

        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*PermitRootLogin\s+
            line: PermitRootLogin no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80901-2
        - CJIS-5.5.6
        - DISA-STIG-RHEL-08-010550
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.5
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-6(2)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-2
        - NIST-800-53-IA-2(5)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_root_login


    - name: Disable SSH Support for User Known Hosts
      block:

        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*IgnoreUserKnownHosts\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes

        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*IgnoreUserKnownHosts\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1

        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*IgnoreUserKnownHosts\s+
            line: IgnoreUserKnownHosts yes
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80902-0
        - DISA-STIG-RHEL-08-010520
        - NIST-800-171-3.1.12
        - NIST-800-53-AC-17(a)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_user_known_hosts


    - name: Disable X11 Forwarding
      block:

        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*X11Forwarding\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes

        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*X11Forwarding\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1

        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*X11Forwarding\s+
            line: X11Forwarding no
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-83360-8
        - DISA-STIG-RHEL-08-040340
        - NIST-800-53-CM-6(b)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_disable_x11_forwarding


    - name: Enable SSH Warning Banner
      block:

        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*Banner\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes

        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*Banner\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1

        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*Banner\s+
            line: Banner /etc/issue
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80905-3
        - CJIS-5.5.6
        - DISA-STIG-RHEL-08-010040
        - NIST-800-171-3.1.9
        - NIST-800-53-AC-17(a)
        - NIST-800-53-AC-8(a)
        - NIST-800-53-AC-8(c)
        - NIST-800-53-CM-6(a)
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_enable_warning_banner







    - name: Force frequent session key renegotiation
      block:

        - name: Check for duplicate values
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*RekeyLimit\s+
            state: absent
          check_mode: true
          changed_when: false
          register: dupes

        - name: Deduplicate values from /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: false
            regexp: (?i)^\s*RekeyLimit\s+
            state: absent
          when: dupes.found is defined and dupes.found > 1

        - name: Insert correct line to /etc/ssh/sshd_config
          lineinfile:
            path: /etc/ssh/sshd_config
            create: true
            regexp: (?i)^\s*RekeyLimit\s+
            line: RekeyLimit {{ var_rekey_limit_size }} {{ var_rekey_limit_time }}
            state: present
            insertbefore: ^[#\s]*Match
            validate: /usr/sbin/sshd -t -f %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82177-7
        - DISA-STIG-RHEL-08-040161
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - sshd_rekey_limit


    - name: Setting unquoted shell-style assignment of 'SSH_USE_STRONG_RNG' to '32' in
        '/etc/sysconfig/sshd'
      block:

        - name: Check for duplicate values
          lineinfile:
            path: /etc/sysconfig/sshd
            create: false
            regexp: ^\s*SSH_USE_STRONG_RNG=
            state: absent
          check_mode: true
          changed_when: false
          register: dupes

        - name: Deduplicate values from /etc/sysconfig/sshd
          lineinfile:
            path: /etc/sysconfig/sshd
            create: false
            regexp: ^\s*SSH_USE_STRONG_RNG=
            state: absent
          when: dupes.found is defined and dupes.found > 1

        - name: Insert correct line to /etc/sysconfig/sshd
          lineinfile:
            path: /etc/sysconfig/sshd
            create: true
            regexp: ^\s*SSH_USE_STRONG_RNG=
            line: SSH_USE_STRONG_RNG=32
            state: present
            insertbefore: ^# SSH_USE_STRONG_RNG
            validate: /usr/bin/bash -n %s
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82462-3
        - DISA-STIG-RHEL-08-010292
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sshd_use_strong_rng


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-86120-3
        - DISA-STIG-RHEL-08-010400
        - NIST-800-53-IA-2(11)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_certificate_verification

    - name: Ensure that "certificate_verification" is not set in /etc/sssd/sssd.conf
      ini_file:
        path: /etc/sssd/sssd.conf
        section: sssd
        option: certificate_verification
        state: absent
      when: '"sssd-common" in ansible_facts.packages'
      tags:
        - CCE-86120-3
        - DISA-STIG-RHEL-08-010400
        - NIST-800-53-IA-2(11)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_certificate_verification

    - name: Ensure that "certificate_verification" is not set in  /etc/sssd/conf.d/*.conf
      ini_file:
        path: /etc/sssd/conf.d/*.conf
        section: sssd
        option: certificate_verification
        state: absent
      when: '"sssd-common" in ansible_facts.packages'
      tags:
        - CCE-86120-3
        - DISA-STIG-RHEL-08-010400
        - NIST-800-53-IA-2(11)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_certificate_verification

    - name: Ensure that "certificate_verification" is set
      ini_file:
        path: /etc/sssd/conf.d/certificate_verification.conf
        section: sssd
        option: certificate_verification
        value: ocsp_dgst = sha1
        state: present
      when: '"sssd-common" in ansible_facts.packages'
      tags:
        - CCE-86120-3
        - DISA-STIG-RHEL-08-010400
        - NIST-800-53-IA-2(11)
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - sssd_certificate_verification


    - name: Ensure usbguard is installed
      package:
        name: usbguard
        state: present
      tags:
        - CCE-82959-8
        - DISA-STIG-RHEL-08-040139
        - NIST-800-53-CM-8(3)
        - NIST-800-53-IA-3
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_usbguard_installed


    - name: Enable service usbguard
      block:

        - name: Gather the package facts
          package_facts:
            manager: auto

        - name: Enable service usbguard
          service:
            name: usbguard
            enabled: 'yes'
            state: started
            masked: 'no'
          when:
            - '"usbguard" in ansible_facts.packages'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82853-3
        - DISA-STIG-RHEL-08-040141
        - NIST-800-53-CM-8(3)(a)
        - NIST-800-53-IA-3
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_usbguard_enabled


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-83774-0
        - DISA-STIG-RHEL-08-040140
        - NIST-800-53-CM-8(3)(a)
        - NIST-800-53-IA-3
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - usbguard_generate_policy

    - name: Generate USBGuard Policy
      block:

        - name: Gather the package facts
          package_facts:
            manager: auto

        - name: Check that the /etc/usbguard/rules.conf exists
          stat:
            path: /etc/usbguard/rules.conf
          register: policy_file

        - name: Create USBGuard Policy configuration
          command: usbguard generate-policy
          register: policy
          when: not policy_file.stat.exists or policy_file.stat.size == 0

        - name: Copy the Generated Policy configuration to a persistent file
          copy:
            content: '{{ policy.stdout }}'
            dest: /etc/usbguard/rules.conf
            mode: 384
          when: not policy_file.stat.exists or policy_file.stat.size == 0

        - name: Enable service usbguard
          service:
            name: usbguard
            enabled: 'yes'
            state: started
            masked: 'no'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"usbguard" in ansible_facts.packages'
      tags:
        - CCE-83774-0
        - DISA-STIG-RHEL-08-040140
        - NIST-800-53-CM-8(3)(a)
        - NIST-800-53-IA-3
        - configure_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - usbguard_generate_policy


